<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="..\github.css" type="text/css" />
</head>
<body>
<h1 id="personium-authentication-plugin-developer-manual">Personium Authentication Plugin Developer Manual</h1>
<p>This is a document of <strong>Personium</strong> Authentication Plugin Developer Manual.</p>
<h2 id="documents">Documents</h2>
<p>It describes the information necessary for developing Personium's Authentication plugin.<br />
This document explains the procedure for creating Authentication plugin.</p>
<h2 id="what-is-an-authentication-plugin">What is an Authentication Plugin?</h2>
<p>The Personium Authentication Plugin is intended to extend the behavior of OAuth 2 token End Point of Cell.<br />
By introducing an Authentication Plugin into the unit, the expanded behavior defined for the plugin is added to the OAuth 2 token end point of all Cells on that unit.<br />
In OAuth 2, the token endpoint is responsible for issuing an access token for resource access.<br />
With the OAuth 2.0 specification, grant_type which is a required parameter of this end point can be used by defining arbitrary absolute URI in addition to the following values which are definition values in the specification.</p>
<ul>
<li>・authorization_code (Not supported）</li>
<li>・password</li>
<li>・refresh_token</li>
<li>・client_credentials (Not supported）</li>
</ul>
<p>reference: <a href="https://tools.ietf.org/html/rfc6749#section-4.5" class="uri">https://tools.ietf.org/html/rfc6749#section-4.5</a></p>
<p>The Personium Authentication Plugin describes it in a corresponding form.</p>
<h2 id="method-of-development">Method of development</h2>
<p>Specifically, the plugin defines the following two points.</p>
<ul>
<li>1.What kind of grant_type value should be handled</li>
<li>2.How to evaluate the input parameter values other than grant_type of the token endpoint and what kind of entity should be recognized as a result</li>
</ul>
<p>In other words, the plugin author implements the above two pieces of information as concrete Java code.<br />
Personium further evaluates the authenticated identification subject information (AuthenticatedIdentity object) returned by the Authentication Plugin as the response 2 above from the following point of view,<br />
We decide whether or not to issue a token, determine the content of issue token, and issue token.</p>
<ul>
<li>・Is there an Account with a Name attribute in the string that can be obtained with getAccountName ()</li>
<li>・If it exists, the type value of the hit Account contains the character string of urn: of the grant_type parameter</li>
</ul>
<h2 id="security-considerations">Security considerations</h2>
<p>Naturally, the plug-in author should generally implement the &quot;parameter value evaluation&quot; above in 2 so that the access agent goes through the appropriate authentication process.<br />
For example, a specific subject (such as a real person who is not a guest etc.) to be originally protected without checking any input value,<br />
Creating such a plug-in as to recognize it and placing it in the unit causes serious security problems.<br />
Therefore, it is necessary for the plug-in author to implement a secure implementation, and the plug-in user (unit administrator) to use only plug-ins that are believed to be secure.</p>
<hr />
<p>The following is an example using the google version Authentication Plugin.</p>
<h2 id="class-structure-of-plugin">Class structure of Plugin</h2>
<p>The border part of the creation plug-in is created.</p>
<p>The class structure diagram of Authentication Plugin is shown below.<br />
<img src="./images/plugin_02.png" title="PluginClass Structure" alt="class structure" /></p>
<blockquote>
<p><strong>Note:</strong> Return value of authentication processing</p>
<ul>
<li>If authentication succeeds, AuthenticatedIdentity is returned.</li>
<li>If authentication fails, a PersoniumCoreAuthnException is thrown.</li>
</ul>
</blockquote>
<h2 id="plugin-behavior">Plugin Behavior</h2>
<p>The operation of Authentication Plugin is shown below.</p>
<p><img src="./images/plugin_01.png" title="PluginBehavior" alt="Plugin behavior" /></p>
<p>　1. Plugin initialization processing<br />
　 PluginManager is called in the PersoniumCoreApplication class and reads all plugins.</p>
<p>　2. Call authentication process<br />
　 In the TokenEndPointResouce class, select the target GrantType Plugin.<br />
　 Execute the authenticate method of the selected plugin.</p>
<blockquote>
<p><strong>Note:</strong></p>
<ul>
<li>Personium Plugin can be executed simply by placing it in the Plugins folder.</li>
<li>The Authenticate Plugin specifies each provider for &quot;Auth&quot; and GrantType as Type, and by writing the authenticate method, the target plugin is selected and the authenticate method is executed.</li>
</ul>
</blockquote>
<h3 id="plugin-initialization-processing">1.Plugin initialization processing</h3>
<h4 id="personiumcoreapplication.java"><i class="icon-file"></i>PersoniumCoreApplication.java</h4>
<pre><code>public class PersoniumCoreApplication extends Application {
    private static PluginManager pm;

    static {
        try {
            TransCellAccessToken.configureX509(PersoniumUnitConfig.getX509PrivateKey(),
                    PersoniumUnitConfig.getX509Certificate(), PersoniumUnitConfig.getX509RootCertificate());
            LocalToken.setKeyString(PersoniumUnitConfig.getTokenSecretKey());
            DataCryptor.setKeyString(PersoniumUnitConfig.getTokenSecretKey());
            pm = new PluginManager();
        } catch (Exception e) {
            PersoniumCoreLog.Server.FAILED_TO_START_SERVER.reason(e).writeLog();
            throw new RuntimeException(e);
        }
    }</code></pre>
<p>　pm = new PluginManager();<br />
　Generate the PluginManager class.</p>
<hr />
<h3 id="call-authentication-process">2.Call authentication process</h3>
<h4 id="tokenendpointresource.java"><i class="icon-file"></i>TokenEndPointResource.java</h4>
<pre><code>            PluginInfo pi = pm.getPluginsByGrantType(grantType);        // Search target plug-in.
            PluginManager pm = PersoniumCoreApplication.getPluginManager();    // Plugin manager.
            if (pi == null) {                                           // Plug-ins do not exist.
                throw PersoniumCoreAuthnException.UNSUPPORTED_GRANT_TYPE.realm(this.cell.getUrl());
            }
            AuthenticatedIdentity ai = null;
            // Invoke the plug-in function.
            Map&lt;String, String&gt; body = new HashMap&lt;String, String&gt;();
            body.put(AuthConst.KEY_TOKEN, idToken);
            Object plugin = (Plugin) pi.getObj();
            try {
                ai = ((AuthPlugin) plugin).authenticate(body);
            } catch (PersoniumCoreAuthnException e) {
                PersoniumCoreAuthnException pcae = PersoniumCoreAuthnException.mapFrom(pe);
                if (pcae != null) {
                    throw pcae;
                }
                throw PersoniumCoreAuthnException.Plugin.PLUGIN_DEFINED_CLIENT_ERROR.reason(pe);

            } catch (Exception e) {
                // Unexpected exception throwed from &quot;Plugin&quot;, create default PersoniumCoreAuthException
                // and set reason from catched Exception.
                throw PersoniumCoreException.Plugin.UNEXPECTED_ERROR.reason(e);
            }</code></pre>
<hr />
<h2 id="procedure-for-creating-plugin">Procedure for creating plugin</h2>
<p>Follow the steps below to create a plugin.</p>
<p>　1. Create Java Source Program<br />
　2. Create manifest File<br />
　3. Export jar File<br />
　4. Setting jar File<br />
　5. Test &amp; debug the Plugin</p>
<hr />
<h3 id="create-java-source-program">1. Create Java Source Program</h3>
<p>Copy GoogleIdTokenAuthPlugin.java and replace all parts marked <strong>google</strong> with the name of the Authentication plugin you will create.</p>
<hr />
<h4 id="googleidtokenauthplugin.java"><i class="icon-file"></i> <strong>GoogleIdTokenAuthPlugin.java</strong></h4>
<pre><code>/**
 * personium.io
 * Copyright 2017 FUJITSU LIMITED
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package io.personium.plugin.auth.oidc;

import java.util.Map;

import io.personium.plugin.base.PluginConfig.OIDC;
import io.personium.plugin.base.PluginLog;
import io.personium.plugin.base.PluginException;
import io.personium.plugin.base.auth.AuthPlugin;
import io.personium.plugin.base.auth.AuthConst;
import io.personium.plugin.base.auth.AuthenticatedIdentity;

public class GoogleIdTokenAuthPlugin implements AuthPlugin {
    /** to String. **/
    public static final String PLUGIN_TOSTRING = &quot;Google Open ID Connect Authentication&quot;;

    /** urn google grantType. **/
    public static final String PLUGIN_GRANT_TYPE = &quot;urn:x-personium:oidc:google&quot;;

    /**
     * toString.
     * @return String
     */
    public String toString(){
        return PLUGIN_TOSTRING;
    }

    /**
     * getType.
     * @return String
     */
    public String getType() {
        return AuthConst.TYPE_AUTH;
    }

    /**
     * getGrantType.
     * @return String
     */
    public String getGrantType() {
        return PLUGIN_GRANT_TYPE;
    }

    /**
     * Google URL
     */
    public static final String URL_HTTPS = &quot;https://&quot;;
    public static final String URL_ISSUER = &quot;accounts.google.com&quot;;

    /**
     * Type値 oidc:google.
     */
    public static final String OIDC_PROVIDER = &quot;google&quot;;

    /**
     * authenticate.
     * @return au AuthenticatedIdentity
     * @throws PluginException
     */
    public AuthenticatedIdentity authenticate(Map &lt;String, String&gt; body) throws PluginException {
        AuthenticatedIdentity ai = null;
        if (body == null) {
            throw PluginException.Authn.REQUIRED_PARAM_MISSING.params(&quot;Body&quot;);
        }

        // verify idToken
        String idToken = (String)body.get(AuthConst.KEY_TOKEN);
        if (idToken == null) {
            throw PluginException.Authn.REQUIRED_PARAM_MISSING.params(&quot;ID Token&quot;);
        }

        GoogleIdToken ret = null;
        try {
            // id_tokenをパースする
            ret = GoogleIdToken.parse(idToken);
        } catch(PluginException pe){
            throw PluginException.Authn.OIDC_INVALID_ID_TOKEN;
        }

        // Tokenの検証   検証失敗時にはPluginExceptionが投げられる
        ret.verify();

        String issuer = ret.getIssuer();
        String aud  = ret.getAudience();
        String mail = ret.getEmail();

        // Token検証成功の後処理
        // Googleが認めたissuerであるかどうか
        if (!issuer.equals(URL_ISSUER) &amp;&amp; !issuer.equals(URL_HTTPS + URL_ISSUER)) {
            PluginLog.OIDC.INVALID_ISSUER.params(issuer).writeLog();
            throw PluginException.Authn.OIDC_AUTHN_FAILED;
        }

        // Googleに登録したサービス/アプリのClientIDかを確認
        // DcConfigPropatiesに登録したClientIdに一致していればOK
        if (!OIDC.isProviderClientIdTrusted(OIDC_PROVIDER, aud)) {
            throw PluginException.Authn.OIDC_WRONG_AUDIENCE.params(aud);
        }

        // 正常な場合、AuthenticatedIdentity を返却する。
        ai = new AuthenticatedIdentity();
        // アカウント名を設定する
        ai.setAccountName(mail);
        // OIDC TYPEを設定する
        ai.setAttributes(AuthConst.KEY_OIDC_TYPE, AuthConst.KEY_OIDC_TYPE + &quot;:&quot; + OIDC_PROVIDER);

        return ai;
    }
}</code></pre>
<p>If Authentication is normal, it returns AuthenticatedIdentity.</p>
<hr />
<h3 id="create-manifest-file">2. Create Manifest File</h3>
<p>To generate the <strong>jar file</strong>, create a manifest.txt file.</p>
<h4 id="manifest.txt"><i class="icon-file"></i><strong>manifest.txt</strong></h4>
<pre><code>Manifest-Version: 1.0
Plugin-Class: io.personium.plugin.auth.google.code.GoogleIdTokenAuthPlugin</code></pre>
<p>Write the information to create the jar file.<br />
Plugin - Class is the format of package + class name.</p>
<hr />
<h3 id="export-jar-file">3. Export jar File</h3>
<h4 id="googleidtokenauthplugin.jar"><i class="icon-file"></i>GoogleIdTokenAuthPlugin.jar</h4>
<p>Create a jar file using Eclipse.</p>
<p>1) Select the created plug-in and click &quot;Export ...&quot; in the menu displayed by right-clicking.</p>
<p><img src="./images/plugin_03.png" title="Eclipse" alt="Eclipse" /><img src="./images/plugin_04.png" title="メニュー" alt="メニューEclipse" /></p>
<p>2) Select &quot;Java - JAR file&quot; and click &quot;Next&gt;&quot;.<br />
<img src="./images/plugin_05.png" alt="Java – JAR file" /></p>
<p>3) Specify the path and name of the Jar file you want to create and click &quot;Next&gt;&quot;.<br />
<img src="./images/plugin_06.png" alt="Create Java Path" /></p>
<p>4) Click &quot;Next&gt;&quot;.<br />
<img src="./images/plugin_07.png" alt="Option" /></p>
<p>5) Specify the manifest file and click &quot;Finish&quot;.<br />
<img src="./images/plugin_08.png" alt="Manifest" /><br />
A Jar file is created in the specified path.</p>
<hr />
<h3 id="setting-jar-file">4. Setting jar File</h3>
<h4 id="personium-unit-config.properties"><i class="icon-hdd"></i>personium-unit-config.properties</h4>
<pre><code># general configurations
io.personium.core.plugin.path=/personium/personium-core/plugins</code></pre>
<p>Place the created jar file in the path of the plugins folder set in the personium-unit-config.properties file.</p>
<hr />
<h3 id="test-debug-the-plugin">5. Test &amp; debug the Plugin</h3>
<h4 id="plugintest.java"><i class="icon-file"></i><strong>PluginTest.java</strong></h4>
<p>io.personium.test.plugin</p>
<p>The final step is testing and debugging.<br />
To test this plugin with junit, add a test processing method to PluginTest.java.<br />
Execute the created junit and confirm that the operation ends normally.</p>
<hr />
</body>
</html>
